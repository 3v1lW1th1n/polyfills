<!doctype html>
<head>
  <script>
  ShadyDOM = { force: true }
  WCT = {waitFor: function (cb) {HTMLImports.whenReady(cb)}}
  </script>
  <script src="../test-flags.js"></script>
  <script src="../../node_modules/wct-browser-legacy/browser.js"></script>
  <script src="../../node_modules/@webcomponents/webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../../node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
  <script src="../../node_modules/@webcomponents/template/template.js"></script>
  <script src="../../node_modules/@webcomponents/html-imports/html-imports.min.js"></script>
  <script src="../../node_modules/@webcomponents/shadydom/shadydom.min.js"></script>
  <script src="../../node_modules/@webcomponents/custom-elements/custom-elements.min.js"></script>
  <script src="../../scoping-shim.min.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
  <script src="../module/generated/make-element.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
</head>
<body>

<style id="testDocumentStyle">
  x-a::part(a) {
    color: red;
  }
</style>

<template id="x-a">
  <x-b exportparts="b:a"></x-b>
</template>

<template id="x-b">
  <x-c exportparts="c:b"></x-c>
</template>

<template id="x-c">
  <x-d exportparts="d:c"></x-d>
</template>

<template id="x-d">
  <div part="d">red</div>
</template>

<x-a></x-a>

<script>
  const black = 'rgb(0, 0, 0)';
  const red = 'rgb(255, 0, 0)';

  function color(...selectors) {
    let node = document.body;
    while (selectors.length > 0) {
      const selector = selectors.shift();
      node = (node.shadowRoot || node).querySelector(selector);
      if (node === null) {
        return null;
      }
    }
    const style = getComputedStyle(node);
    return style.color;
  }

  suite('shadow parts', function() {
    suiteSetup(async function() {
      window.ShadyCSS.CustomStyleInterface.addCustomStyle(
          document.querySelector('#testDocumentStyle'));
      makeElement('x-a');
      makeElement('x-b');
      makeElement('x-c');
      makeElement('x-d');
      await new Promise(r => requestAnimationFrame(r));
    });

    test('exportparts different name', function() {
      // TODO(aomarks) This is failing because addCustomStyle translates our
      // style to "x-a:not(.style-scope)::part(a) {  color: red; }".
      assert.equal(
        color('x-a', 'x-b', 'x-c', 'x-d', '[part~=d]'),
        red);
    });
  });
</script>
</body>
