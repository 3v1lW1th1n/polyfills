<!doctype html>
<head>
  <script>
  WCT = {waitFor: function (cb) {HTMLImports.whenReady(cb)}}
  </script>
  <script src="../test-flags.js"></script>
  <script src="../../node_modules/wct-browser-legacy/browser.js"></script>
  <script src="../../node_modules/@webcomponents/webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../../node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
  <script src="../../node_modules/@webcomponents/template/template.js"></script>
  <script src="../../node_modules/@webcomponents/html-imports/html-imports.min.js"></script>
  <script src="../../node_modules/@webcomponents/shadydom/shadydom.min.js"></script>
  <script src="../../node_modules/@webcomponents/custom-elements/custom-elements.min.js"></script>
  <script src="../../scoping-shim.min.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
  <script src="../module/generated/make-element.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
  <script src="./utils.js"></script>
</head>
<body>

<style id="testDocumentStyle">
  x-a::part(p1 p2) {
    color: red;
  }
  x-a::part(p1) {
    font-style: italic;
  }
  x-a::part(p2) {
    background-color: blue;
  }
</style>

<template id="x-a">
  <x-b exportparts="p1,p2"></x-b>
</template>

<template id="x-b">
  <x-c exportparts="p1,p2"></x-c>
</template>

<template id="x-c">
  <div part="p1">italic</div>
  <div part="p2">blue bg</div>
  <div part="p1 p2">red italic blue bg</div>
</template>

<x-a></x-a>

<script>
  suite('document style', function() {
    let p1, p2, p1p2;
    suiteSetup(async function() {
      window.ShadyCSS.CustomStyleInterface.addCustomStyle(
          document.querySelector('#testDocumentStyle'));
      makeElement('x-a');
      makeElement('x-b');
      makeElement('x-c');
      await new Promise(r => requestAnimationFrame(r));
      const c = pierce('x-a', 'x-b', 'x-c');
      p1 = pierce(c, '[part=p1]');
      p2 = pierce(c, '[part=p2]');
      p1p2 = pierce(c, '[part="p1 p2"]');
    });

    test('selector with 2 parts only matches elements with both parts', function() {
      if (navigator.userAgent.includes('Chrome') &&
            (!window.ShadyDOM || !window.ShadyDOM.inUse)) {
        // Multiple parts is not supported natively as of Chrome 79.0.3945.130,
        // but should be in the next release, see
        // https://bugs.chromium.org/p/chromium/issues/detail?id=955897#c4
        this.skip();
      }
      assert.equal(getComputedStyle(p1).color, black);
      assert.equal(getComputedStyle(p2).color, black);
      assert.equal(getComputedStyle(p1p2).color, red);
    });

    test('element with 2 parts receives styles for both parts', function() {
      assert.equal(getComputedStyle(p1p2).fontStyle, 'italic');
      assert.equal(getComputedStyle(p1p2).backgroundColor, blue);
    });
  });
</script>
</body>
