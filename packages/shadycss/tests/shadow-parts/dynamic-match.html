<!doctype html>
<head>
  <script>
  ShadyDOM = { force: true }
  WCT = {waitFor: function (cb) {HTMLImports.whenReady(cb)}}
  </script>
  <script src="../test-flags.js"></script>
  <script src="../../node_modules/wct-browser-legacy/browser.js"></script>
  <script src="../../node_modules/@webcomponents/webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../../node_modules/es6-promise/dist/es6-promise.auto.min.js"></script>
  <script src="../../node_modules/@webcomponents/template/template.js"></script>
  <script src="../../node_modules/@webcomponents/html-imports/html-imports.min.js"></script>
  <script src="../../node_modules/@webcomponents/shadydom/shadydom.min.js"></script>
  <script src="../../node_modules/@webcomponents/custom-elements/custom-elements.min.js"></script>
  <script src="../../scoping-shim.min.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
  <script src="../module/generated/make-element.js"></script>
  <script src="../../custom-style-interface.min.js"></script>
  <script src="./utils.js"></script>
</head>
<body>

<style id="testDocumentStyle">
  x-a.red::part(a) {
    color: red;
  }

  .greenContainer x-a::part(a) {
    color: green;
  }

  .blueContainer x-a.blue::part(a) {
    color: blue;
  }

  .orangeContainer > x-a::part(a) {
    color: orange;
  }
</style>

<template id="x-a">
  <x-b exportparts="b:a"><slot></slot></x-b>
</template>

<template id="x-b">
  <x-c exportparts="c:b"><slot></slot></x-c>
</template>

<template id="x-c">
  <x-d exportparts="d:c"><slot></slot></x-d>
</template>

<template id="x-d">
  <div part="d"><slot></slot></div>
</template>

<x-a class="black">black</x-a>

<x-a class="red">red</x-a>

<div class="greenContainer">
  <x-a>green</x-a>
</div>

<div class="blueContainer">
  <x-a class="blue">blue</x-a>
  <x-a class="notBlue1">black</x-a>
</div>
<x-a class="blue notBlue2">black</x-a>

<div class="orangeContainer">
  <div>
    <x-a class="notOrange">black</x-a>
  </div>
  <x-a class="orange">orange</x-a>
</div>

<script>
  suite('dynamic match', function() {
    suiteSetup(async function() {
      window.ShadyCSS.CustomStyleInterface.addCustomStyle(
          document.querySelector('#testDocumentStyle'));
      makeElement('x-a');
      makeElement('x-b');
      makeElement('x-c');
      makeElement('x-d');
      await new Promise(r => requestAnimationFrame(r));
    });

    test('x-el.class::part(part)', function() {
      assert.equal(color('x-a.black', 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
      assert.equal(color('x-a.red', 'x-b', 'x-c', 'x-d', '[part~=d]'), red);
    });

    test('.class x-el::part(part)', function() {
      assert.equal(color('.greenContainer x-a', 'x-b', 'x-c', 'x-d', '[part~=d]'), green);
    });

    test('.class x-el.class::part(part)', function() {
      assert.equal(color('x-a.blue', 'x-b', 'x-c', 'x-d', '[part~=d]'), blue);
      assert.equal(color('x-a.notBlue1', 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
      assert.equal(color('x-a.notBlue2', 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
    });

    test('.class > x-el.class::part(part)', function() {
      assert.equal(color('x-a.orange', 'x-b', 'x-c', 'x-d', '[part~=d]'), orange);
      assert.equal(color('x-a.notOrange', 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
    });

    test('class added and removed', async function() {
      const a = document.createElement('x-a');
      document.body.appendChild(a);
      await new Promise(r => requestAnimationFrame(r));
      assert.equal(color(a, 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
      a.classList.add('red');
      assert.equal(color(a, 'x-b', 'x-c', 'x-d', '[part~=d]'), red);
      a.classList.remove('red');
      assert.equal(color(a, 'x-b', 'x-c', 'x-d', '[part~=d]'), black);
      document.body.removeChild(a);
    });
  });
</script>
</body>
