<!doctype html>
<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <meta charset="utf-8">
  <script src="../node_modules/@webcomponents/webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../node_modules/@webcomponents/template/template.js"></script>
  <script>
    ShadyDOM = {force: true};
    if (window.customElements) {
      customElements.forcePolyfill = true;
    }
  </script>
  <script src="../shadydom.min.js"></script>
  <script src="../node_modules/@webcomponents/custom-elements/custom-elements.min.js"></script>
  <script>
    // Ensure customElements are updated when document is ready.
    if (customElements.polyfillWrapFlushCallback) {
      customElements.polyfillWrapFlushCallback(function(cb) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', cb);
        } else {
          cb();
        }
      });
    }
  </script>

  <script src="../node_modules/wct-browser-legacy/browser.js"></script>
</head>
<body>

  <script>
    window.defineTestElement = function(name, connected) {
      var template = document.querySelector('#' + name);
      // es5 compat class
      function Klass() {
        const self = (window.Reflect && Reflect.construct)
          ? Reflect.construct(HTMLElement, [], this.constructor || Klass)
          : HTMLElement.call(this);
        return self;
      }

      Klass.prototype = Object.create(HTMLElement.prototype, {
        'constructor': {
          value: Klass,
          configurable: true,
          writable: true
        }
      });

      Klass.prototype.connectedCallback = function() {
        if (!this._initialized) {
          this._initialized = true;
          if (connected) {
            connected.call(this);
          }
          if (template) {
            this.attachShadow({mode: 'open'});
            this.shadowRoot.appendChild(document.importNode(template.content, true));
          }
        }
      }

      customElements.define(name, Klass);
    }

    window.makeFocusable = function() {
      this.setAttribute('tabIndex', -1);
    }
  </script>

  <template id="x-test"><div>before</div><slot></slot><div>after</div></template>
  <script>
    defineTestElement('x-test');
  </script>

<script>

  'use strict';

  suite('nativeTree', function() {

    let el;

    setup(function() {
      el = document.createElement('x-test');
      let d = document.createElement('div');
      d.textContent = 'content';
      el.appendChild(d);
      document.body.appendChild(el);
      ShadyDOM.flush();
    });

    teardown(function() {
      el.parentNode.removeChild(el);
    });


    test('node accessors', function() {
      let srFirst = el.shadowRoot.firstChild;
      let srLast = el.shadowRoot.lastChild;
      let content = el.firstChild;
      assert.equal(ShadyDOM.nativeAccessor(el, 'firstChild'), srFirst);
      assert.equal(ShadyDOM.nativeAccessor(el, 'lastChild'), srLast);
      assert.equal(ShadyDOM.nativeAccessor(srFirst, 'parentNode'), el);
      assert.equal(ShadyDOM.nativeAccessor(srFirst, 'nextSibling'), content);
      assert.equal(ShadyDOM.nativeAccessor(content, 'nextSibling'), srLast);
      assert.equal(ShadyDOM.nativeAccessor(srLast, 'previousSibling'), content);
      assert.equal(ShadyDOM.nativeAccessor(content, 'previousSibling'), srFirst);
      assert.deepEqual(Array.from(ShadyDOM.nativeAccessor(el, 'childNodes')), [srFirst, content, srLast])
    });

    test('element accessors', function() {
      let srFirst = el.shadowRoot.firstChild;
      let srLast = el.shadowRoot.lastChild;
      let content = el.firstChild;
      assert.equal(ShadyDOM.nativeAccessor(el, 'firstElementChild'), srFirst);
      assert.equal(ShadyDOM.nativeAccessor(el, 'lastElementChild'), srLast);
      assert.equal(ShadyDOM.nativeAccessor(srFirst, 'parentElement'), el);
      assert.equal(ShadyDOM.nativeAccessor(srFirst, 'nextElementSibling'), content);
      assert.equal(ShadyDOM.nativeAccessor(content, 'nextElementSibling'), srLast);
      assert.equal(ShadyDOM.nativeAccessor(srLast, 'previousElementSibling'), content);
      assert.equal(ShadyDOM.nativeAccessor(content, 'previousElementSibling'), srFirst);
      assert.deepEqual(Array.from(ShadyDOM.nativeAccessor(el, 'children')), [srFirst, content, srLast])
    });

    test('fragment accessors', function() {
      let el = document.createDocumentFragment();
      let d1 = document.createElement('div');
      let d2 = document.createElement('div');
      el.appendChild(d1);
      el.appendChild(d2);
      assert.equal(ShadyDOM.nativeAccessor(d1, 'parentNode'), el);
      assert.equal(ShadyDOM.nativeAccessor(d1, 'nextElementSibling'), d2);
      assert.equal(ShadyDOM.nativeAccessor(d2, 'previousElementSibling'), d1);
    });

    test('fragment element accessors', function() {
      // IE/Edge does not have element accessors on DocumentFragment.
      if (navigator.userAgent.match(/Trident|Edge/)) {
        this.skip();
      }
      let el = document.createDocumentFragment();
      let d1 = document.createElement('div');
      let d2 = document.createElement('div');
      el.appendChild(d1);
      el.appendChild(d2);
      assert.equal(ShadyDOM.nativeAccessor(el, 'firstElementChild'), d1);
      assert.equal(ShadyDOM.nativeAccessor(el, 'lastElementChild'), d2);
      assert.deepEqual(Array.from(ShadyDOM.nativeAccessor(el, 'children')), [d1, d2])
    });

    test('textConent', function() {
      assert.equal(ShadyDOM.nativeAccessor(el, 'textContent'), 'beforecontentafter');
    });

    test('innerHTML', function() {
      assert.equal(ShadyDOM.nativeAccessor(el, 'innerHTML'), '<div>before</div><div>content</div><div>after</div>');
    });

  });

  suite('nativeMethods', function() {

    let el;

    setup(function() {
      el = document.createElement('x-test');
      let d = document.createElement('div');
      d.textContent = 'content';
      el.appendChild(d);
      document.body.appendChild(el);
      ShadyDOM.flush();
    });

    teardown(function() {
      el.parentNode.removeChild(el);
    });

    test('appendChild', function() {
      let d = document.createElement('div');
      ShadyDOM.nativeMethod(el, 'appendChild', d);
      assert.equal(ShadyDOM.nativeAccessor(el, 'lastChild'), d);
    });

    test('insertBefore', function() {
      let d = document.createElement('div');
      let srFirst = el.shadowRoot.firstChild;
      ShadyDOM.nativeMethod(el, 'insertBefore', d, srFirst);
      assert.equal(ShadyDOM.nativeAccessor(el, 'firstChild'), d);
    });

    test('removeChild', function() {
      let srFirst = el.shadowRoot.firstChild;
      let srLast = el.shadowRoot.lastChild;
      let content = el.firstChild;
      ShadyDOM.nativeMethod(el, 'removeChild', srFirst);
      ShadyDOM.nativeMethod(el, 'removeChild', content);
      ShadyDOM.nativeMethod(el, 'removeChild', srLast);
      assert.equal(ShadyDOM.nativeAccessor(el, 'childNodes').length, 0);
    });

    test('querySelector/querySelectorAll', function() {
      let srFirst = el.shadowRoot.firstChild;
      let srLast = el.shadowRoot.lastChild;
      let content = el.firstChild;
      assert.equal(ShadyDOM.nativeMethod(el, 'querySelector', 'div'), srFirst);
      let qsa = ShadyDOM.nativeMethod(el, 'querySelectorAll', '*');
      qsa = Array.prototype.slice.call(qsa);
      assert.deepEqual(qsa,[srFirst, content, srLast]);
    });

    test('contains', function() {
      let srFirst = el.shadowRoot.firstChild;
      assert.isTrue(ShadyDOM.nativeMethod(el, 'contains', srFirst));
      assert.isTrue(ShadyDOM.nativeMethod(document.documentElement, 'contains', srFirst));
    });

  });

</script>

</body>
</html>
